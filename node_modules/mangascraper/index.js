const fetch = require("node-fetch");
const cheerio = require("cheerio");


const searchUrl = 'https://myanimelist.net/manga.php?q=';
const mangaUrl = 'https://myanimelist.net/manga/';


async function searchManga(query) {
    return fetch(`${searchUrl}${query}`)
    .then(res => res.text())
    .then(body => {
        const mangas = [];
        const $ = cheerio.load(body);
        $('a.hoverinfo_trigger' && 'a.fw-b').each(function(i, element) {
            const $element = $(element);
            const alink = $element.attr('href').slice(30);
            const manga = {
                alink
            }
            mangas.push(manga);
            return false;
        });
    
        return mangas;
        
    });
}


async function getManga(alink) {
    return fetch(`${mangaUrl}${alink}`)
        .then(res => res.text())
        .then(body => {

            const $ = cheerio.load(body);

            const title = $('.h1').text().trim();
            const score = $('.score').text().trim();
            const type = $('.information a' && '.type a').text().trim();
            const ranked = $('.ranked strong').text().trim();
            const popularity = $('.popularity strong').text().trim();
            const image = $('.ac').attr('src');
            const synopsis = $('span[itemprop="description"]').text().trim();


            infoarray = {
                title,
                score,
                type,
                ranked,
                popularity,
                image,
                synopsis
            };


            return infoarray;

        });
}



module.exports = {
    searchManga,
    getManga,
    mangaUrl
}